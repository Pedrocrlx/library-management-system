{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ user.name }}'s Dashboard - Midnight Library</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <style>
        body {
            background-color: #020617;
            font-family: 'Plus Jakarta Sans', sans-serif;
            color: #f8fafc;
        }

        .glass-nav {
            background: rgba(2, 6, 23, 0.8);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .glass-card {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .fade-in-up {
            animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            opacity: 0;
            transform: translateY(20px);
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="min-h-screen flex flex-col selection:bg-violet-500 selection:text-white">

    <!-- Navbar -->
    <nav class="fixed top-0 w-full z-50 glass-nav">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <a href="{% url 'index' %}" class="flex items-center gap-2 group">
                <div
                    class="w-10 h-10 rounded-xl bg-gradient-to-br from-violet-600 to-fuchsia-600 flex items-center justify-center text-xl shadow-lg shadow-violet-500/20 group-hover:scale-110 transition-transform duration-300">
                    ðŸ“š
                </div>
                <span
                    class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-400">Midnight
                    Library</span>
            </a>
            <div class="flex items-center gap-4">
                <span class="text-slate-400 text-sm hidden sm:block">Welcome, <span class="text-white font-medium">{{ user.name }}</span></span>
                <a href="{% url 'auth_logout' %}"
                    class="px-4 py-2 rounded-xl bg-red-500/10 text-red-400 hover:bg-red-500/20 text-sm font-medium transition-colors border border-red-500/20">
                    Logout
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow pt-32 pb-20 px-6">
        <div class="max-w-5xl mx-auto">

            <!-- Messages -->
            {% if messages %}
            <div class="mb-8 fade-in-up">
                {% for message in messages %}
                <div
                    class="p-4 rounded-xl {% if message.tags == 'error' %}bg-red-500/10 border-red-500/20 text-red-400{% else %}bg-emerald-500/10 border-emerald-500/20 text-emerald-400{% endif %} border text-center font-medium">
                    {{ message }}
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Header & Stats -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12 fade-in-up">
                <div class="md:col-span-3 mb-4">
                    <h1 class="text-3xl md:text-4xl font-bold mb-2">My Dashboard</h1>
                    <p class="text-slate-400">Manage your loans and account status</p>
                </div>

                <!-- Stat Card 1 -->
                <div class="glass-card p-6 rounded-2xl flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-violet-500/20 flex items-center justify-center text-2xl">
                        ðŸ“–
                    </div>
                    <div>
                        <p class="text-slate-400 text-sm font-medium">Borrowed Books</p>
                        <p class="text-2xl font-bold text-white">{{ borrowed_count }}</p>
                    </div>
                </div>

                <!-- Stat Card 2 -->
                <div class="glass-card p-6 rounded-2xl flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-emerald-500/20 flex items-center justify-center text-2xl">
                        âœ¨
                    </div>
                    <div>
                        <p class="text-slate-400 text-sm font-medium">Available Limit</p>
                        <p class="text-2xl font-bold text-white">{{ remaining }}</p>
                    </div>
                </div>

                <!-- Stat Card 3 -->
                <div class="glass-card p-6 rounded-2xl flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-blue-500/20 flex items-center justify-center text-2xl">
                        ðŸ“…
                    </div>
                    <div>
                        <p class="text-slate-400 text-sm font-medium">Account Status</p>
                        <p class="text-2xl font-bold text-white">Active</p>
                    </div>
                </div>
            </div>

            <!-- Borrowed Books Section -->
            <div class="fade-in-up" style="animation-delay: 0.1s;">
                <div class="flex justify-between items-end mb-6">
                    <h2 class="text-2xl font-bold">Current Loans</h2>
                    <a href="{% url 'index' %}"
                        class="text-violet-400 hover:text-violet-300 text-sm font-medium transition-colors">Browse Books
                        â†’</a>
                </div>

                <div class="grid gap-6">
                    {% for entry in borrowed_books %}
                    <div
                        class="glass-card p-6 rounded-2xl flex flex-col md:flex-row gap-6 items-start md:items-center group hover:border-violet-500/30 transition-all duration-300">

                        <!-- Book Icon/Image Placeholder -->
                        <div
                            class="w-full md:w-24 h-32 rounded-lg bg-slate-800 flex items-center justify-center text-4xl shadow-lg flex-shrink-0 overflow-hidden">
                            {% if entry.book_id.thumbnail %}
                            <img src="{{ entry.book_id.thumbnail }}" alt="{{ entry.book_id.book_name }}"
                                class="w-full h-full object-cover">
                            {% else %}
                            ðŸ“˜
                            {% endif %}
                        </div>

                        <!-- Details -->
                        <div class="flex-grow">
                            <div class="flex flex-wrap gap-2 mb-2">
                                <span
                                    class="px-2.5 py-1 rounded-md bg-violet-500/10 text-violet-400 text-xs font-bold border border-violet-500/10">
                                    {{ entry.book_id.categoriesperbook_set.first.category_id.category_name }}
                                </span>
                            </div>
                            <h3 class="text-xl font-bold text-white mb-1">{{ entry.book_id.book_name }}</h3>
                            <p class="text-slate-400 text-sm mb-4">by {{ entry.book_id.author }}</p>

                            <div class="flex flex-wrap gap-4 text-sm">
                                <div class="flex items-center gap-2 text-slate-400">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                        <line x1="16" y1="2" x2="16" y2="6"></line>
                                        <line x1="8" y1="2" x2="8" y2="6"></line>
                                        <line x1="3" y1="10" x2="21" y2="10"></line>
                                    </svg>
                                    Borrowed: <span class="text-slate-200">{{ entry.borrowed_date|date:"M d, Y" }}</span>
                                </div>
                                <div class="flex items-center gap-2 text-slate-400">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <polyline points="12 6 12 12 16 14"></polyline>
                                    </svg>
                                    Due: <span class="text-amber-400">{{ entry.due_date|date:"M d, Y" }}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Action -->
                        <div class="w-full md:w-auto flex-shrink-0">
                            <button type="button"
                                class="w-full md:w-auto px-6 py-3 rounded-xl bg-slate-800 hover:bg-violet-600 text-white font-semibold transition-all border border-slate-700 hover:border-violet-500 shadow-lg"
                                onclick="openReturnModal('{{ entry.id }}', '{{ entry.book_id.book_name|escapejs }}')">
                                Return Book
                            </button>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-16 glass-card rounded-2xl border-dashed border-2 border-slate-800">
                        <div class="text-6xl mb-4 opacity-50">ðŸ“š</div>
                        <h3 class="text-xl font-bold text-white mb-2">No books borrowed</h3>
                        <p class="text-slate-400 mb-6">You haven't borrowed any books yet.</p>
                        <a href="{% url 'index' %}"
                            class="px-6 py-3 rounded-xl bg-violet-600 hover:bg-violet-500 text-white font-medium transition-colors">
                            Browse Library
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </div>

        </div>
    </main>

    <script>
        function openReturnModal(id, title) {
            const modal = document.getElementById('return-modal');
            const form = document.getElementById('return-form');
            const bookTitle = document.getElementById('return-book-title');

            form.action = `/return/${id}/`;
            bookTitle.textContent = title;

            modal.classList.remove('hidden');
        }

        function closeReturnModal() {
            const modal = document.getElementById('return-modal');
            modal.classList.add('hidden');
        }
    </script>
</body>

<!-- Return Confirmation Modal -->
<div id="return-modal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <!-- Backdrop -->
    <div class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm transition-opacity" onclick="closeReturnModal()"></div>

    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <!-- Modal Panel -->
            <div
                class="relative transform overflow-hidden rounded-2xl bg-slate-900 border border-slate-700 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-md">
                <div class="px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div
                            class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-violet-500/10 sm:mx-0 sm:h-10 sm:w-10">
                            <svg class="h-6 w-6 text-violet-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3" />
                            </svg>
                        </div>
                        <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left">
                            <h3 class="text-base font-semibold leading-6 text-white" id="modal-title">Return Book</h3>
                            <div class="mt-2">
                                <p class="text-sm text-slate-400">Are you sure you want to return "<span
                                        id="return-book-title" class="text-white font-medium"></span>"?</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-slate-800/50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                    <form id="return-form" method="post">
                        {% csrf_token %}
                        <button type="submit"
                            class="inline-flex w-full justify-center rounded-xl bg-violet-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-violet-500 sm:ml-3 sm:w-auto">Return
                            Book</button>
                    </form>
                    <button type="button"
                        class="mt-3 inline-flex w-full justify-center rounded-xl bg-slate-800 px-3 py-2 text-sm font-semibold text-slate-300 shadow-sm ring-1 ring-inset ring-slate-700 hover:bg-slate-700 sm:mt-0 sm:w-auto"
                        onclick="closeReturnModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</div>

</html>