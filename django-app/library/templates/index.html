{% load static %}
<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Midnight Library</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">

  <style>
    body {
      background-color: #020617;
      /* slate-950 */
      font-family: 'Plus Jakarta Sans', sans-serif;
      color: #f8fafc;
      /* slate-50 */
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #0f172a;
    }

    ::-webkit-scrollbar-thumb {
      background: #334155;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #475569;
    }

    /* Glassmorphism */
    .glass-nav {
      background: rgba(2, 6, 23, 0.8);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .glass-card {
      background: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    /* Animations */
    .fade-in-up {
      animation: fadeInUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      opacity: 0;
      transform: translateY(20px);
    }

    @keyframes fadeInUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .hover-glow:hover {
      box-shadow: 0 0 20px rgba(139, 92, 246, 0.3);
    }

    /* Hide scrollbar for horizontal scroll */
    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }

    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    .mask-linear {
      mask-image: linear-gradient(to right, black 0%, black 85%, transparent 100%);
      -webkit-mask-image: linear-gradient(to right, black 0%, black 85%, transparent 100%);
    }
  </style>
</head>

<body class="min-h-screen flex flex-col selection:bg-violet-500 selection:text-white">

  <!-- Navbar -->
  <nav class="fixed top-0 w-full z-50 glass-nav transition-all duration-300">
    <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
      <a href="{% url 'index' %}" class="flex items-center gap-2 group">
        <div
          class="w-10 h-10 rounded-xl bg-gradient-to-br from-violet-600 to-fuchsia-600 flex items-center justify-center text-xl shadow-lg shadow-violet-500/20 group-hover:scale-110 transition-transform duration-300">
          üìö
        </div>
        <span class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-400">Midnight
          Library</span>
      </a>

      <div class="flex items-center gap-4">
        {% if request.session.user_id %}
        {% if request.session.user_role == 'admin' %}
        <a href="{% url 'admin_dashboard' %}"
          class="px-5 py-2.5 rounded-xl bg-slate-800 hover:bg-slate-700 text-sm font-medium transition-colors border border-slate-700">Admin
          Panel</a>
        {% else %}
        <a href="{% url 'user_dashboard' %}"
          class="px-5 py-2.5 rounded-xl bg-slate-800 hover:bg-slate-700 text-sm font-medium transition-colors border border-slate-700">My
          Books</a>
        {% endif %}
        <a href="{% url 'auth_logout' %}"
          class="w-10 h-10 rounded-xl bg-slate-800 hover:bg-red-500/20 hover:text-red-400 flex items-center justify-center transition-all border border-slate-700"
          title="Logout">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
        </a>
        {% else %}
        <a href="{% url 'auth_login' %}" class="text-slate-300 hover:text-white font-medium transition-colors">Login</a>
        <a href="{% url 'auth_register' %}"
          class="px-5 py-2.5 rounded-xl bg-violet-600 hover:bg-violet-500 text-white font-medium shadow-lg shadow-violet-500/25 transition-all hover:-translate-y-0.5">Get
          Started</a>
        {% endif %}
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="flex-grow pt-32 pb-20 px-6">
    <div class="max-w-7xl mx-auto">

      <!-- Hero Section -->
      <div class="text-center mb-16 fade-in-up" style="animation-delay: 0.1s;">
        <h1 class="text-5xl md:text-7xl font-extrabold mb-6 tracking-tight">
          Discover your next <br>
          <span class="text-transparent bg-clip-text bg-gradient-to-r from-violet-400 via-fuchsia-400 to-white">great
            adventure.</span>
        </h1>
        <p class="text-slate-400 text-lg md:text-xl max-w-2xl mx-auto leading-relaxed">
          Explore our curated collection of knowledge and stories. From timeless classics to modern masterpieces.
        </p>
      </div>

      <!-- Messages -->
      {% if messages %}
      <div class="max-w-3xl mx-auto mb-8 fade-in-up">
        {% for message in messages %}
        <div
          class="p-4 rounded-xl {% if message.tags == 'error' %}bg-red-500/10 border-red-500/20 text-red-400{% else %}bg-emerald-500/10 border-emerald-500/20 text-emerald-400{% endif %} border text-center font-medium">
          {{ message }}
        </div>
        {% endfor %}
      </div>
      {% endif %}

      <!-- Search & Filter Section -->
      <div class="mb-12 fade-in-up" style="animation-delay: 0.2s;">

        {% if borrowed_books %}
        <div class="max-w-3xl mx-auto mb-8">
          <h2 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4 px-2">Currently Borrowing</h2>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
            {% for borrow in borrowed_books %}
            <div
              class="flex items-center gap-4 p-3 rounded-xl bg-slate-900/50 border border-slate-800 hover:border-violet-500/30 transition-colors group">
              <div class="w-12 h-16 flex-shrink-0 rounded-lg overflow-hidden bg-slate-800 shadow-md">
                {% if borrow.book_id.thumbnail %}
                <img src="{{ borrow.book_id.thumbnail }}" class="w-full h-full object-cover"
                  alt="{{ borrow.book_id.book_name }}">
                {% else %}
                <img src="https://placehold.co/400x600/1e293b/a78bfa?text=No+Cover" class="w-full h-full object-cover"
                  alt="No Cover">
                {% endif %}
              </div>
              <div class="min-w-0">
                <h3 class="text-sm font-bold text-white truncate group-hover:text-violet-400 transition-colors"
                  title="{{ borrow.book_id.book_name }}">
                  {{ borrow.book_id.book_name }}
                </h3>
                <p class="text-xs text-slate-500 mt-1">Due: {{ borrow.due_date|date:"M d" }}</p>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        <form id="search-form" method="get" action="{% url 'index' %}" class="max-w-3xl mx-auto mb-8">
          <div class="relative group">
            <div
              class="absolute -inset-1 bg-gradient-to-r from-violet-600 to-fuchsia-600 rounded-2xl blur opacity-25 group-hover:opacity-50 transition duration-500">
            </div>
            <div class="relative flex items-center bg-slate-900 rounded-xl border border-slate-800 shadow-2xl">
              <span class="pl-6 text-slate-500">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="11" cy="11" r="8"></circle>
                  <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
              </span>
              <input id="search-input" type="text" name="q" value="{{ request.GET.q }}"
                placeholder="Search by title, author, or category..."
                class="w-full bg-transparent border-none text-white placeholder-slate-500 px-6 py-5 text-lg focus:ring-0 focus:outline-none">
              <button type="submit"
                class="mr-2 px-6 py-3 bg-slate-800 hover:bg-slate-700 text-white rounded-lg font-medium transition-colors border border-slate-700">
                Search
              </button>
            </div>
          </div>
        </form>


        <!-- Categories -->
        <div id="categories-scroll" class="flex justify-start gap-3 overflow-x-auto pb-4 px-4 no-scrollbar">
          <a href="{% url 'index' %}"
            class="px-5 py-2 rounded-full border {% if not request.GET.q %}bg-white text-slate-900 border-white{% else %}bg-slate-900/50 text-slate-400 border-slate-800 hover:border-slate-600 hover:text-white{% endif %} transition-all whitespace-nowrap font-medium">
            All Books
          </a>
          {% for category in all_categories %}
          <a href="{% url 'index' %}?q={{ category.category_name }}"
            class="px-5 py-2 rounded-full border {% if request.GET.q == category.category_name %}bg-white text-slate-900 border-white{% else %}bg-slate-900/50 text-slate-400 border-slate-800 hover:border-slate-600 hover:text-white{% endif %} transition-all whitespace-nowrap font-medium">
            {{ category.category_name }}
          </a>
          {% endfor %}
        </div>
      </div>

      <script>
        const scrollContainer = document.getElementById("categories-scroll");
        scrollContainer.addEventListener("wheel", (evt) => {
          evt.preventDefault();
          scrollContainer.scrollLeft += evt.deltaY;
        });
      </script>

      <!-- Books Grid -->
      <div id="books-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8 fade-in-up"
        style="animation-delay: 0.3s;">
        {% for book in books %}
        <div
          class="book-item group relative bg-slate-900 rounded-2xl border border-slate-800 overflow-hidden hover:border-violet-500/50 transition-all duration-500 hover:shadow-2xl hover:shadow-violet-500/10 flex flex-col h-full">

          <!-- Image Container -->
          <div class="relative aspect-[2/3] overflow-hidden bg-slate-800">
            {% if book.thumbnail %}
            <img src="{{ book.thumbnail }}"
              class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
              onerror="this.onerror=null; this.src='https://placehold.co/400x600/1e293b/a78bfa?text=No+Cover';">
            {% else %}
            <img src="https://placehold.co/400x600/1e293b/a78bfa?text=No+Cover" alt="No Cover"
              class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110">
            {% endif %}

            <!-- Overlay Gradient -->
            <div class="absolute inset-0 bg-gradient-to-t from-slate-950 via-transparent to-transparent opacity-60">
            </div>

            <!-- Badge -->
            <div class="absolute top-4 right-4">
              {% if book.quantity > 0 %}
              <span
                class="px-3 py-1 rounded-full bg-emerald-500/20 text-emerald-400 text-xs font-bold border border-emerald-500/20 backdrop-blur-md">
                {{ book.quantity }} Available
              </span>
              {% else %}
              <span
                class="px-3 py-1 rounded-full bg-red-500/20 text-red-400 text-xs font-bold border border-red-500/20 backdrop-blur-md">
                Out of Stock
              </span>
              {% endif %}
            </div>
          </div>

          <!-- Content -->
          <div class="p-6 flex flex-col flex-grow">
            <div class="mb-4">
              <div class="flex flex-wrap gap-2 mb-3">
                {% for category in book.categories %}
                <span
                  class="text-[10px] uppercase tracking-wider font-bold text-violet-400 bg-violet-500/10 px-2 py-1 rounded-md border border-violet-500/10">
                  {{ category }}
                </span>
                {% endfor %}
              </div>
              <h3
                class="text-xl font-bold text-white leading-tight mb-1 group-hover:text-violet-400 transition-colors line-clamp-2"
                title="{{ book.title }}">
                {{ book.title }}
              </h3>
              <p class="text-slate-400 text-sm font-medium">{{ book.authors }}</p>
            </div>

            <div class="mt-auto pt-4 border-t border-slate-800">
              {% if user_id and user_role != 'admin' %}
              {% if book.quantity > 0 %}
              {% if reached_limit %}
              <button disabled
                class="block w-full py-3 rounded-xl bg-slate-800 text-slate-500 font-bold text-center cursor-not-allowed border border-slate-700">
                Limit Reached
              </button>
              {% else %}
              <button
              onclick="openBorrowModal('{{ book.id }}', '{{ book.title|escapejs }}')"
              class="block w-full py-3 rounded-xl bg-white text-slate-950 font-bold text-center hover:bg-violet-400 transition-colors shadow-lg shadow-white/5">
              Borrow Book
              </button>
              {% endif %}
              {% else %}
              <button disabled
                class="block w-full py-3 rounded-xl bg-slate-800 text-slate-500 font-bold text-center cursor-not-allowed">
                Unavailable
              </button>
              {% endif %}
              {% else %}
              <a href="{% url 'auth_login' %}"
                class="block w-full py-3 rounded-xl bg-slate-800 text-slate-300 font-bold text-center hover:bg-slate-700 transition-colors border border-slate-700">
                Login to Borrow
              </a>
              {% endif %}
            </div>
          </div>
        </div>
        {% empty %}
        <div class="col-span-full flex flex-col items-center justify-center py-32 text-center fade-in-up">
          <div
            class="w-24 h-24 rounded-full bg-slate-800 flex items-center justify-center mb-6 text-4xl border border-slate-700">
            üîç
          </div>
          <h3 class="text-2xl font-bold text-white mb-2">No books found</h3>
          <p class="text-slate-400 max-w-md mx-auto">
            We couldn't find any books matching your search. Try adjusting your filters or search terms.
          </p>
          <a href="{% url 'index' %}"
            class="mt-6 px-6 py-3 rounded-xl bg-violet-600 text-white font-medium hover:bg-violet-500 transition-colors">
            Clear Filters
          </a>
        </div>
        {% endfor %}
      </div>

      <!-- Sentinel for Client-Side Infinite Scroll -->
      <div id="sentinel" class="h-20 flex items-center justify-center mt-8">
        <div class="w-8 h-8 border-4 border-violet-500 border-t-transparent rounded-full animate-spin hidden"
          id="loading-spinner"></div>
      </div>

    </div>
  </main>

  <!-- Footer -->
  <footer class="border-t border-slate-800 bg-slate-950 py-12">
    <div class="max-w-7xl mx-auto px-6 flex flex-col md:flex-row justify-between items-center gap-6">
      <div class="flex items-center gap-2">
        <div
          class="w-8 h-8 rounded-lg bg-gradient-to-br from-violet-600 to-fuchsia-600 flex items-center justify-center text-sm">
          üìö
        </div>
        <span class="font-bold text-slate-200">Midnight Library</span>
      </div>
      <p class="text-slate-500 text-sm">
        &copy; 2025 Library Management System. All rights reserved.
      </p>
      <div class="flex gap-6 text-slate-500">
        <a href="#" class="hover:text-violet-400 transition-colors">Privacy</a>
        <a href="#" class="hover:text-violet-400 transition-colors">Terms</a>
        <a href="#" class="hover:text-violet-400 transition-colors">Contact</a>
      </div>
    </div>
  </footer>

  <script>
    const searchInput = document.getElementById('search-input');
    const booksGrid = document.getElementById('books-grid');
    let timeout = null;

    // Client-side Infinite Scroll Logic
    let visibleCount = 4;
    const batchSize = 4;

    function setupInfiniteScroll() {
      const items = document.querySelectorAll('.book-item');
      const sentinel = document.getElementById('sentinel');
      const spinner = document.getElementById('loading-spinner');

      // Reset visibility
      visibleCount = 4;

      // Initial hide
      updateVisibility(items);

      // Setup Observer
      if (window.bookObserver) window.bookObserver.disconnect();

      window.bookObserver = new IntersectionObserver((entries) => {
        if (entries[0].isIntersecting) {
          // Check if we have more to show
          if (visibleCount < items.length) {
            spinner.classList.remove('hidden');
            // Simulate small delay for effect or just show immediately
            setTimeout(() => {
              visibleCount += batchSize;
              updateVisibility(items);
              spinner.classList.add('hidden');
            }, 300);
          }
        }
      });

      if (sentinel) window.bookObserver.observe(sentinel);
    }

    function updateVisibility(items) {
      items.forEach((item, index) => {
        if (index < visibleCount) {
          item.classList.remove('hidden');
        } else {
          item.classList.add('hidden');
        }
      });
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', setupInfiniteScroll);


    // Live Search
    searchInput.addEventListener('input', function (e) {
      clearTimeout(timeout);
      timeout = setTimeout(function () {
        const query = e.target.value;
        const url = `{% url 'index' %}?q=${encodeURIComponent(query)}`;

        fetch(url)
          .then(response => response.text())
          .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newGrid = doc.getElementById('books-grid');
            if (newGrid) {
              booksGrid.innerHTML = newGrid.innerHTML;
              // Re-initialize scroll logic for new results
              setupInfiniteScroll();
            }
          });
      }, 300);
    });


   
    function openBorrowModal(id, title) {
        const modal = document.getElementById('borrow-modal');
        const form = document.getElementById('borrow-form');
        const bookTitle = document.getElementById('borrow-book-title');

        form.action = `/borrow/${id}/`;
        bookTitle.textContent = title;

        modal.classList.remove('hidden');
    }

    function closeBorrowModal() {
        document.getElementById('borrow-modal').classList.add('hidden');
    }
    

  </script>
</body>

<!-- Borrow Confirmation Modal -->
<div id="borrow-modal" class="fixed inset-0 z-50 hidden">
    <!-- Backdrop -->
    <div class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm" onclick="closeBorrowModal()"></div>

    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">

            <div class="relative transform overflow-hidden rounded-2xl bg-slate-900 border border-slate-700 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-md">
                <div class="px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-violet-500/10 sm:mx-0 sm:h-10 sm:w-10">
                            üìö
                        </div>
                        <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left">
                            <h3 class="text-base font-semibold leading-6 text-white">Borrow Book</h3>
                            <div class="mt-2">
                                <p class="text-sm text-slate-400">
                                    Are you sure you want to borrow "<span id="borrow-book-title" class="text-white font-medium"></span>"?
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-800/50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                    <form id="borrow-form" method="post">
                        {% csrf_token %}
                        <button type="submit" class="inline-flex w-full justify-center rounded-xl bg-violet-600 px-3 py-2 text-sm font-semibold text-white hover:bg-violet-500 sm:ml-3 sm:w-auto">
                            Confirm Borrow
                        </button>
                    </form>

                    <button onclick="closeBorrowModal()" class="mt-3 inline-flex w-full justify-center rounded-xl bg-slate-800 px-3 py-2 text-sm font-semibold text-slate-300 ring-1 ring-slate-700 hover:bg-slate-700 sm:mt-0 sm:w-auto">
                        Cancel
                    </button>
                </div>
            </div>

        </div>
    </div>
</div>

</html>